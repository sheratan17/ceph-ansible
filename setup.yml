---
- name: Update packages and install dependencies
  hosts: node,manager
  become: true
  tasks:
    - name: Update all packages
      yum:
        name: "*"
        state: latest
    - name: Install required packages
      yum:
        name: attr,wget,nano,lvm2,quota,wget,nano,curl,vim,lsof,git,sshpass,epel-release,zip,python3,podman
        state: present
    - name: Update all packages again
      yum:
        name: "*"
        state: latest
    - name: Download cephadm
      get_url:
        url: https://github.com/ceph/ceph/raw/quincy/src/cephadm/cephadm
        dest: /root
        mode: "0755"
    - name: Add ceph repository
      command: ./cephadm add-repo --release quincy
      args:
        chdir: /root
    - name: Install ceph-common
      command: ./cephadm install ceph-common
      args:
        chdir: /root
    - name: Update /etc/hosts file
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
      loop:
        - 10.89.1.11 node1
        - 10.89.1.12 node2
        - 10.89.1.13 node3
        - 10.89.1.14 node4
- name: Bootstrap Ceph on manager host
  hosts: manager
  become: true
  tasks:
    - name: Install required packages
      yum:
        name: nginx
        state: present
    - name: SSH Keyscan
      command: ssh-keyscan -t rsa {{ item }} >> /root/.ssh/known_hosts
      with_items:
        - node1
        - node2
        - node3
        - node4
    - name: Install Cephadm
      command: ./cephadm install
      args:
        chdir: /root
    - name: Bootstrap Ceph
      command: ./cephadm bootstrap --mon-ip 10.89.1.11 --cluster-network=10.89.1.0/24
      args:
        chdir: /root
    - name: Copy ceph.pub to all node
      command: ssh-copy-id -f -i /etc/ceph/ceph.pub -o StrictHostKeyChecking=no root@{{ item }}
      with_items:
        - node1
        - node2
        - node3
        - node4
